% This file was converted to LaTeX by Writer2LaTeX ver. 1.0 beta3
% see http://writer2latex.sourceforge.net for more info
% Потом поправлено руками, потому как нагенерилась ересь какая-то.

\documentclass[a4paper]{article}
\usepackage[a4paper, top=17mm, bottom=17mm, left=17mm, right=17mm]{geometry}
\usepackage[cp1251]{inputenc}
\usepackage[T2A,T1]{fontenc}
\usepackage[colorlinks,filecolor=blue,citecolor=green,unicode,pdftex]{hyperref}
\usepackage{cmap}
\usepackage[english,russian]{babel}
\usepackage{amsmath}
\usepackage{amssymb,amsfonts,textcomp}
\usepackage{color}
\usepackage{array}
\usepackage{hhline}
\hypersetup{colorlinks=true, linkcolor=blue, citecolor=blue, filecolor=blue, urlcolor=blue, pdftitle=1, pdfauthor=, pdfsubject=, pdfkeywords=}
\usepackage[pdftex]{graphicx}
% Раскомментить тем, у кого этот пакет есть. Шрифт станет заметно красивее.
% \usepackage{literat}
\usepackage{indentfirst}

% Text styles
\newcommand\textstyleInternetlink[1]{\textcolor{blue}{#1}}

\sloppy
\pagestyle{empty}

\title{Архитектура среды визуального моделирования QReal}

\author{А.Н. Терехов \and Т.А. Брыксин \and Ю.В. Литвинов \and К.К. Смирнов \and Г.А. Никандров \and В.Ю. Иванов \and Е.И. Такун}
\date{}
\begin{document}

\maketitle
\thispagestyle{empty}

\begin{quote}
\small\noindent
Существует довольно много сред визуального моделирования, однако часто
появляется необходимость создать новую CASE-систему, как правило, предназначенную для какой-либо 
специальной предметной области. Разработка таких систем сложна, общепринятые подходы к 
их архитектуре отсутствуют, поэтому описание опыта разработки и обсуждение вариантов их
реализации представляется довольно важным. В этой статье описана архитектура CASE-системы QReal, 
представлено обоснование ряда решений, принятых при её создании, и указаны выявленные трудности.
\end{quote}

\section*{Введение}
В настоящее время для разработки программного и аппаратного обеспечения довольно активно используется 
визуальное моделирование. Для автоматизации процесса разработки используются CASE-средства, в которых 
разрабатываемая система представляется в виде модели на каком-либо визуальном языке программирования. 
Широкое распространение получил язык UML, для различных предметных областей создаются специализированные 
языки, такие как BPMN\footnote{Business Process Modelling Notation, http://www.bpmn.org/}, 
IDEF*\footnote{Семейство стандартов Integration DEFinition, http://www.idef.com/} и др.

Существует множество CASE-пакетов, реализующих различные подмножества или варианты языка UML и другие 
визуальные языки. Такие пакеты существуют для различных платформ, поддерживают различные процессы и методологии 
разработки, предназначаются для различных целей\footnote{См., например, http://www.objectsbydesign.com/tools/umltools\_byCompany.html 
или http://en.wikipedia.org/wiki/List\_of\_UML\_tools}. 
Средства визуального моделирования часто встраиваются в текстовые средства разработки
(например, визуальные редакторы в составе Microsoft Visual Studio
\footnote{http://msdn.microsoft.com/en-us/library/aa288743(VS.71).aspx}, редактор UML-диаграмм в среде 
NetBeans\footnote{http://www.netbeans.org/features/uml/} и т.д.). 
Тем не менее, зачастую возникает необходимость создавать специализированные 
CASE-средства, предназначенные для какой-либо узкой предметной области (См., например,
обсуждение в работе~\cite{amln} или, более подробно, в~\cite{koznovDsl}).

Сложность разработки CASE-пакетов довольно велика, поскольку приходится решать проблему разработки 
графических редакторов диаграмм, организации хранения и оперативного доступа к большим объёмам данных 
со сложной структурой, поддержки процесса разработки программного обеспечения, включая 
многопользовательскую работу, версионирование и т.д. 
Необходимо также обеспечить сквозной характер применения технологии: реализовать генерацию кода по 
визуальным моделям, поддержку внесения ручных изменений в сгенерированную систему, обеспечить 
согласованность фрагментов модели на всех этапах разработки программы.

Общепринятые подходы к решению этих проблем отсутствуют, а существующие технологии и средства 
% TODO: может быть, сноска со ссылкой на статьи Кознова, описывающие эти подходы?
% Типа "Попытки систематизировать такие подходы предпринимались в работах <вписать нужное>,
% но <вписать нужное | подходы не получили широкого признания/обсуждения/so on>
разработки специализированных CASE-пакетов, такие как Eclipse GMF\footnote{http://www.eclipse.org/modeling/gmf/} 
и Microsoft DSL Tools\footnote{http://msdn.microsoft.com/en-us/library/bb126235.aspx},
обладают рядом недостатков, делающих их широкое использование затруднительным. 
% TODO: пирожок тому, кто найдёт ссылку на что-нибудь уважаемое с критикой оных средств
Поэтому сформулированные выше проблемы нуждаются в обсуждении, поддержанном информацией, 
подобной той, которая изложена в данной статье.

В настоящей работе представлена архитектура системы QReal --- CASE-пакета и средства для 
создания визуальных редакторов (мета-CASE-системы). При разработке к системе QReal 
были сформулированы следующие требования:
\begin{itemize}
  \item Многоплатформенность --- возможность перекомпиляции исходного кода для другой целевой 
    системы без внесения в него изменений.
  \item Распределенность:
  \begin{itemize}
        \item возможность удаленного доступа к общему репозиторию (как в пределах 
	  локальной сети, так и посредством Internet);
        \item возможность конкурентного доступа --- наличие системы блокировок (как на 
	  уровне диаграмм, так и на уровне элементов) и механизма разграничения прав доступа пользователей.
  \end{itemize}
  \item Наличие средства автоматического создания произвольных графических редакторов (в том 
    числе и пользователями, не владеющими навыками программирования).
  \item Набор графических редакторов должен поддерживать, как минимум, диаграммы UML 2.1, 
    BPEL\footnote{Business Process Execution Language, http://www.oasis-open.org/specs/\#wsbpelv2.0} и диаграммы требований.
    % TODO: что-нибудь про требования, из диплома Симоновой?
  \item Внешняя простота архитектуры и прозрачность интерфейсов взаимодействия модулей:
  \begin{itemize}
        \item широкие возможности для расширения и масштабирования CASE-пакета;
        \item облегчение процесса его сопровождения.
  \end{itemize}
  \item Распространение под лицензией GPLv2
        (независимость от закрытых, проприетарных библиотек, технологий и средств разработки).
\end{itemize}

Кроме того, QReal в дополнение к графическим редакторам и репозиторию, 
распространяемым по лицензии GPLv2, будет включать в себя набор генераторов 
форм ввода/вывода, схем баз данных и исполняемого кода для различных платформ, 
распространяемых на коммерческой основе.

Реализация системы обладает следующими особенностями:
\begin{itemize}
  \item Клиент-серверная архитектура --- графические редакторы и генераторы кода 
    работают как клиенты, взаимодействующие с общим для нескольких пользователей хранилищем данных.
  \item Архитектура Model/View --- отделение графического интерфейса и генераторов кода 
    от модели данных, общающейся с удалённым репозиторием.
  \item Реализация на основе библиотеки Qt\footnote{http://www.qtsoftware.com/}
    --- для обеспечения кроссплатформенности на уровне исходных кодов.
  \item Генеративный подход к созданию новых графических редакторов --- позволяет 
    создавать редакторы диаграмм для специализированных визуальных языков не прибегая к программированию.
\end{itemize}

Далее в статье приводится подробное обсуждение этих особенностей, обоснование ряда принятых 
технических решений и описание выявленных трудностей.

\section{Существующие решения}

Системы визуального моделирования делятся на две группы --- универсальные 
и предметно-ориентированные системы~\cite{koznov}. Универсальные CASE-пакеты
не имеют какой-либо специализированной ориентации и поддерживают
визуальные языки общего назначения (как правило, UML). Такие пакеты
являются коробочными и довольно широко представлены на рынке.
Наиболее известные из них --- 
Enterprise Architect\footnote{http://www.sparxsystems.com.au/}, 
IBM Rational Rose\footnote{http://www-01.ibm.com/software/awdtools/developer/rose/},
Microsoft Visio\footnote{http://office.microsoft.com/ru-ru/visio/FX100487861049.aspx}, 
Visual Paradigm\footnote{http://www.visual-paradigm.com/product/vpuml/}. 
Как правило, универсальные CASE-пакеты имеют открытые программные интерфейсы, позволяющие
расширять их функциональность. Чрезмерная универсальность
таких средств делает их применение на всех этапах разработки менее
выгодным по сравнению с предметно-ориентированными средствами.

Предметно-ориентированные системы предназначены для определённой
предметной области, достаточно узкой, чтобы обеспечить
наибольшую выгоду от применения визуального моделирования
и обеспечить эффективную генерацию кода. Такие инструменты
могут разрабатываться компаниями для своих внутренних нужд,
для решения задач именно того процесса, для поддержки которого
они создаются. Для облегчения реализации предметно-ориентированных визуальных языков
существуют коробочные пакеты (такие как Eclipse GMF, Microsoft DSL Tools), 
а также настраиваемые CASE-системы, позволяющие пользователю описывать свои визуальные языки
(такие как MetaEdit+\footnote{http://www.metacase.com/}, 
GME\footnote{http://www.isis.vanderbilt.edu/Projects/gme/}~\cite{gme},
Rational Software Architect\footnote{http://www-01.ibm.com/software/awdtools/swarchitect/}). 

\subsection{Инструментарий Microsoft DSL Tools}

Инструментарий Microsoft DSL Tools является частью среды разработки Visual Studio
и предназначен для создания встроенных в Visual Studio визуальных редакторов. Процесс
создания нового редактора состоит из описания метамодели языка на
специальном визуальном языке DSL Tools, генерации редактора и внесения
в сгенерированный код ручных изменений для реализации дополнительной функциональности,
такой как валидация моделей. Сохранение ручных изменений после перегенерации
редактора осуществляется за счёт использования частичных классов (partial classes) .Net.

Язык описания метамоделей состоит из доменых классов (domain classes), которыми задаются
отдельные сущности проектируемого языка, нескольких видов отношений (ассоциация, агрегирование,
наследование) (следует отметить, что отношение в DSL Tools может иметь атрибуты и
представляется, по сути, классом), а также средствами задания нотации --- геометрические
фигуры и свойства линий для отношений. Недостающие графические примитивы можно
реализовать самостоятельно на C\#.

DSL Tools хорошо подходит для реализации несложных предметно-ориентированных языков,
которые будут использоваться внутри среды Visual Studio. Независимый графический 
редактор с помощью DSL Tools создать невозможно. Реализация сложных визуальных
редакторов с возможностями, не поддерживаемыми DSL Tools изначально, как правило,
требует больших объёмов кодирования на C\#.

\subsection{Технология Eclipse GMF}

Технология Eclipse GMF (Graphical Modelling Framework) создана на базе
среды разработки с открытыми исходными кодами Eclipse. GMF предназначена
для быстрой разработки графических редакторов, в основном, интегрируемых в
Eclipse, и построена на двух широко используемых библиотеках --- Eclipse
Modeling Framework (EMF) и Graphical Editing Framework (GEF). Архитектура
построенного с помощью GMF пакета основана на шаблоне проектирования 
Model/View/Controller (MVC), где для создания моделей используется EMF,
а для создания представлений и контроллеров используется GEF.

Процесс создания визуальных редакторов в GMF состоит из следующих шагов.
\begin{itemize}
  \item Разработка доменной модели --- абстрактного синтаксиса разрабатываемого
    предметно-ориентированного языка. Доменная модель может быть разработана
    с помощью графического редактора Ecore (входящего в состав GMF), импортирована
    из XMI-документа, из набора аннотированных Java-интерфейсов или из XML-схемы.
  \item Разработка графической модели --- описания графической нотации разрабатываемого языка.
  \item Разработка модели инструментов --- описания элементов панели инструментов.
  \item Разработка модели соответствия --- связи между тремя предыдущими моделями.
  \item Создание модели генератора --- промежуточного представления разрабатываемого
    редактора. Эта модель автоматически генерируется по модели соответствия и дополняется
    вручную.
  \item Генерация целевого визуального редактора.
\end{itemize}

Данная технология позволяет создавать независимые от Eclipse графические редакторы,
однако, довольно сложна в использовании и громоздка.

\subsection{Rational Software Architect}

IBM Rational Software Architect --- развитие идей некогда популярной CASE-системы Rational Rose.
Этот инструмент представляет из себя полноценную среду разработки и предназначен прежде 
всего для проектирования с использованием UML 2.0, имеет развитые средства генерации 
кода и возвратного проектирования для языков Java и C++. К наиболее интересным особенностям 
этого инструмента можно отнести следующие:
\begin{itemize}
  \item автоматический поиск архитектурных паттернов и антипаттернов в моделях;
  \item возможность определять свои паттерны проектирования и шаблоны генерации кода;
  \item возможность автоматически следить за целостностью архитектуры разрабатываемого приложения,
    поддержание стиля кодирования;
  \item поддержка трассируемости, инструменты для отслеживания связи требований с реализацией;
  \item поддержка многопользовательской работы, интеграция с системами контроля версий.
\end{itemize}

Rational Software Architect может использоваться и как платформа для реализации
предметно-ориентированных визуальных языков. Сам этот CASE-пакет является расширением среды
Eclipse и построен с использованием технологии GMF, что делает возможным использование
возможностей Eclipse для написания плагинов. Кроме того, сам Software Architect 
имеет средства определения профилей UML, произвольных предметно-ориентированных языков (с версии 7.5),
а также возможность использования любых их комбинаций. 
% Только никто не знает, как. По крайней мере, в демке можно создавать только профили, и то...
Независимый редактор таким способом построить нельзя.
% Наверное :)

\subsection{Технология REAL}

CASE-пакет QReal является развитием идей технологии \mbox{REAL}~\cite{real}, 
разработанной на кафедре системного программирования математико-механического 
факультета Санкт-Петербургского государственного университета. 
REAL является технологией разработки информационных систем и
систем реального времени и представляет собой набор взаимосвязанных
графических редакторов диаграмм UML 1.4 и SDL\footnote{Specification and Description Language, http://www.sdl-forum.org/}
-диаграмм, объединенных в единую среду разработки. Это CASE-средство является открытой системой,
настраиваемой под различные задачи (на его основе был создан набор
технологических решений для различных областей, например~\cite{realIt}) и
обладающее способностью интегрироваться с другими средствами
разработки.

Решение о разработке нового CASE-пакета было принято по следующим соображениям:

\begin{itemize}
  \item набор визуальных языков, поддерживаемых системой \mbox{REAL}, устарел с появлением
        UML 2.0;
  \item процесс добавления нового редактора в систему происходил кодированием на
        языке C++ (пусть даже и с учетом факта переиспользования компонент), 
        что кажется нам весьма неоптимальным. К тому же, добавление нового редактора 
        требовало от разработчиков знания архитектуры CASE-пакета в целом;
  \item реализация графово-графической библиотеки CASE-пакета основана
        на устаревшей библиотеке MFC, что усложняет задачу сопровождения продукта
        и перенос на другие платформы.
\end{itemize}

Была предпринята попытка модификации отдельных модулей
REAL (сначала графово-графической библиотеки, а потом и репозитория) с целью устранения указанных
недостатков, однако быстро стало ясно, что осуществление подобного рода
масштабирования и расширения системы неосуществимо, если возможности
для этого не были учтены при изначальном проектировании архитектуры
приложения в целом.

\subsection{Выводы}

% Вывод - QReal никому не нужен, статья - тоже, юзайте GMF :)

Разработка новой CASE-системы общего назначения (поддерживающей язык UML
и генерацию в достаточно широкий класс систем, например, веб-приложения) на данный момент
представляется задачей, вероятность возникновения которой крайне низка ---
большое количество довольно качественных систем такого типа представлено на рынке, 
с различной функциональностью и в разных ценовых категориях. Однако же, такие
системы не предназначены для разработки пользовательских визуальных языков,
редакторов и генераторов к ним. 

Поскольку задача создания предметно-ориентированных визуальных языков
возникает всё чаще, необходимо иметь возможность быстро создавать CASE-системы
для их поддержки. Такие CASE-системы не могут быть коробочными, поскольку 
сами языки и требования к генераторам, редакторам и т.д. могут сильно отличаться
не только в разных компаниях, но и в разных проектах в рамках одной компании.
% TODO: Переписать эту ахинею, кто шарит.
Microsoft DSL Tools и Eclipse GMF --- примеры инструментариев для быстрой
разработки таких CASE-систем, однако они, по нашему мнению, обладают некоторыми 
недостатками: первый из них довольно прост в использовании, но предназначен 
для решения довольно узкого круга задач и для работы в специфическом 
окружении (в наборе инструментов Microsoft Visual Studio), поддерживать сложные
визуальные языки со сложной графической нотацией в DSL Tools весьма тяжело. Второй инструментарий
существенно более универсален (Rational Software Architect может послужить примером
того, что можно сделать с помощью Eclipse GMF) и существенно более сложен в
использовании. Кроме того, использование какого-либо готового инструментария
неизбежно накладывает ограничения на архитектуру и возможности разрабатываемой 
CASE-системы, поэтому мы считаем общую задачу создания CASE-системы
заслуживающей обсуждения.
% Ещё бы, не пропадать же статье :)

\section{Основные концепции создаваемого прототипа}

Поскольку основу коллектива разработчиков QReal составляют студенты и аспиранты
кафедры системного программирования СПбГУ, было принято решение базировать
процесс разработки на основе практики прототипирования. Так, на
начальном этапе было создано несколько тестовых демонстрационных
приложений, в результате чего были опробованы принципы и основные
механизмы работы средств, предоставляемых инструментарием Qt, и
сформировано общее представление о будущей архитектуре системы. На
дальнейших этапах архитектура основных компонент пересматривалась,
некоторые из них переписывались практически полностью, однако общие
архитектурные принципы оставались неизменны.

Система QReal имеет архитектуру "клиент-сервер" с использованием
шаблона проектирования Model/View. Каждый клиент имеет свою модель, которая 
является прокси-объектом репозитория, а в роли представлений выступают 
различные элементы пользовательского интерфейса. 

Следует пояснить, почему был выбран именно шаблон Model/View,
а не более общий шаблон Model/View/Controller --- иначе функциональность
контроллера брала бы на себя логика графических редакторов, что 
не очень удобно, поскольку редакторы в системе QReal генерируются, а не
программируются вручную. Разнесение функциональности редакторов по разным
модулям усложнило бы генерацию, не предоставив существенных преимуществ.
Кроме того, шаблон Model/View поддерживается инструментарием Qt, который был
выбран как основной при реализации системы. 
Подробнее о данном решении можно узнать из дипломной работы Брыксина Т.А.~\cite{bryksin}.

\subsection{Графический интерфейс. Выбор инструментария}

Графический интерфейс CASE-пакета обычно содержит вполне определенный набор элементов. В
QReal они представлены следующими компонентами (см. рис. 1):

\begin{itemize}
  \item \textit{Инспектор объектов (Object Explorer).} Представляет
        собой дерево объектов, содержащее все элементы в открытом в данный
        момент репозитории, отсортированные по их типам. Бывает
        удобен для обзора проекта в целом и при добавлении на текущую диаграмму 
				уже существующего в проекте объекта, например, не принадлежащего никаким диаграммам.
  \item \textit{Инспектор диаграмм (Diagram Explorer).} Отображает все
        пользовательские диаграммы и элементы на них в виде дерева. Один элемент
        может принадлежать нескольким диаграммам, тогда в
        инспекторе он будет отображаться как потомок всех диаграмм, которым он
        принадлежит (в инспекторе объектов и в репозитории всем этим ``копиям''
        будет соответствовать один элемент).
  \item \textit{Редактор свойств (Property Editor).} Предоставляет информацию о выделенном 
        элементе и позволяет изменять значения его атрибутов.
  \item \textit{Палитра компонентов.} Отображает все возможные для добавления на
        диаграмму визуальные элементы.
  \item \textit{Меню, панели инструментов.} Содержат основные операции над репозиторием, 
        диаграммами, объектами и т.д.
  \item \textit{Рабочая область графического редактора диаграмм}. Основная
        рабочая область CASE-пакета. Здесь осуществляется отображение и 
	модификация создаваемых пользователем диаграмм. 
\end{itemize}

\begin{figure} [ht]
  \begin{center}
    \includegraphics[width=\textwidth]{draft04-img1.png}
    \caption{Главное окно QReal}
    \label{mainWindow}
  \end{center}
\end{figure}

Следует заметить, что реализация подобного рода элементов графического
интерфейса, как правило, является платформо-зависимой задачей, т.е.
требует использования системных графических библиотек, что противоречит
требованию многоплатформенности. Известно несколько способов решения задач такого
рода:

\begin{itemize}
  \item Использование переносимости на уровне бинарного кода, например, байт-код Java. 
	Java-приложения могут работать на любом устройстве, для которого существует 
	реализация виртуальной машины.
  \item Переносимость приложения на уровне исходных кодов. Это достигается путем
	использования многоплатформенных инструментариев, инкапсулирующих в себе 
	реализацию базовых графических примитивов для различных операционных систем. Библиотеки
	подобного рода предоставляют единый интерфейс для работы с ними вне
	зависимости от используемой операционной системы. 
	Наиболее распространенными готовыми решениями в данной области
	являются инструментальные средства Qt и GTK+.
\end{itemize}

Основным достоинством первого подхода является отсутствие необходимости перекомпиляции, что
не очень существенно для CASE-систем, поскольку отношение времени компиляции исходных кодов 
к общему времени работы с продуктом невелико. Достоинством второго подхода является более
высокая производительность, что при работе с большими моделями может быть достаточно важно.

В процессе разработки архитектуры и реализации прототипов модулей CASE-пакета было решено
использовать инструментарий Qt. Этот выбор показался нам удачным по следующим причинам:

\begin{itemize}
  \item Qt --- динамически развивающийся проект, за время работы над прототипом
        было выпущено несколько новых версий этого инструментария,
        каждая из которых существенно расширяла возможности предыдущей.
  \item Qt с версии 4 не позиционируется разработчиками как набор графических библиотек, это полноценный
        инструментарий для разработки многоплатформенных приложений. Помимо элементов
				графического интерфейса он включает в себя классы для
        работы с сетью, базами данных, XML и многое другое.
  \item В Qt с версии 4 входит Qt Model/View Framework, который 
        предоставляет для использования набор готовых реализаций стандартных
        моделей и представлений и возможность быстро создавать новые.
  \item Распространение с версии 4.5 под лицензией LGPL, что даёт возможность
				использовать Qt в коммерческих приложениях.
  \item Перспективы развития инструментария, например, портирование QReal средствами
	      Qt в веб-приложение.
\end{itemize}


% TODO: Без понятия, в чём отличие репозитория на основе реляционной СУБД от аналога в REAL.
% Пусть Знающие Люди напишут.
\subsection{Репозиторий на основе реляционной СУБД}

Репозиторий является ответственным за хранение данных и предоставление
интерфейсов доступа к ним для других компонент. В связи с требованием
распределенности, предъявляемым к разрабатываемому
CASE-пакету (а именно, возможности удаленного доступа пользователей к репозиторию), было принято решение
реализовывать репозиторий в соответствии с архитектурой клиент/сервер.
Таким образом, клиентская часть репозитория будет встраиваться в сам
CASE-пакет, а серверная может быть физически размещена на другом компьютере, доступном по локальной сети
или через интернет. Серверная составляющая может быть реализована:

\begin{itemize}
  \item на основе стандартных средств версионного контроля (например,
        CVS, Visual SourceSafe или Subversion);
  \item в виде хранилища данных с помощью набора плоских файлов;
  \item как надстройка над реляционной СУБД (большого опыта работы с
        объектно-ориентированными СУБД участники проекта в то время не имели).
\end{itemize}

Последний вариант сначала показался нам наиболее удачным по
следующим причинам:

\begin{itemize}
  \item системы управления базами данных по своему назначению ориентированы на
        хранение и эффективную обработку больших объемов информации, поэтому с
        ростом числа пользовательских диаграмм и элементов на них потери в
        производительности репозитория окажутся незначительными;
  \item наличие механизмов блокировок (на уровне таблиц и записей), транзакций и
        разграничений прав пользователей дает возможность для организации
        многопользовательского конкурентного доступа к репозиторию практически
        ``из коробки'';
  \item использование простейших утилит администрирования, поставляющихся в
        составе СУБД, позволяет осуществлять импорт/экспорт содержимого базы
        данных в виде ее снимков (snapshots), которые, в частности, могут быть 
        помещены в систему контроля версий.
  \item возможность физического разнесения клиента и сервера репозитория, а
        также унифицированные средства для работы с разными СУБД,
        представляемые Qt, снимают ограничения на выбор как используемой СУБД, так и операционной системы
        серверной части, поэтому CASE-пакет становится более гибким в настройке и использовании;
  \item поддержка системами управления базами данных стандартных сетевых
        протоколов TCP/IP снимает необходимость реализации сетевых компонент серверной части и
        позволяет организовать доступ к серверу репозитория из глобальных
        сетей, в том числе и из Интернет;
\end{itemize}

Хранимые данные (информация о диаграммах и элементах) в общем виде имеют
графовое представление, к тому же один элемент может принадлежать
разным диаграммам, поэтому для их хранения с использованием реляционных
таблиц базы данных применялось специальное преобразование. Для
хранения данных требовались таблицы, хранящие метатипы элементов,
сами элементы с их логическими свойствами, и графические свойства элементов
с данными о потомках объектов (которые могут быть разными на разных диаграммах).

Более подробное описание схемы базы данных можно найти в дипломной работе Никандрова Г.~\cite{nikandrov}.

\subsection{Генеративный подход к созданию редакторов}

CASE-пакет --- это система визуального моделирования, в состав которой входит определенное число
графических редакторов. И будь то редакторы бизнес-процессов, схем баз
данных, компонент программного обеспечения или структуры организаций,
по своему внутреннему устройству они будут довольно похожи.

Редактор инкапсулирует в себе информацию о наборе объектов, допустимых
на диаграммах данного типа, и должен быть способен правильно
интерпретировать хранящиеся в репозитории значения атрибутов элементов
(например, использовать некоторые из них как параметры при
отрисовке). Кроме того, редактор должен иметь представление о логических правилах размещения
элементов на соответствующих типах диаграмм (например, возможность
соединять некоторые элементы ассоциациями, возможность одних элементов
быть контейнерами для других и т.д.).

Создавать набор таких редакторов кодированием их ``вручную'' кажется нам
неразумным по следующим причинам:

\begin{itemize}
  \item с ростом числа редакторов значительно снижается сопровождаемость кода;
  \item слабая расширяемость --- добавление новой функциональности требует
        изучения (а нередко и существенного рефакторинга) уже существующего
        кода;
  \item опасная масштабируемость --- создание дополнительного редактора,
        являющегося типовым для данного CASE-средства, чаще всего будет
        осуществляться методом Copy/Paste с
        дальнейшими доработками полученного после копирования текста, что ведёт как к
        появлению новых ошибок, связанных с неполнотой вносимых
        правок, так и к размножению уже существующих;
  \item происходит неизбежное усложнение внутреннего устройства модуля
        редакторов, и, как следствие, усложнение архитектуры
        CASE-пакета в целом.
\end{itemize}

В соответствии с этим был предложен следующий подход к автоматическому
созданию графических редакторов:

\begin{itemize}
  \item путем анализа типовых редакторов выделяется базовая функциональность
        абстрактного редактора, которая кодируется ``вручную'' на целевом языке
        высокого уровня (в нашем случае, на C++);
  \item специфика метамоделей нужных диаграмм (или наиболее полное их подмножество) 
        описывается с помощью специального XML-формата;
  \item по этим описаниям генерируется C++ код,
        который в совокупности с базовой функциональностью полностью реализует
        требуемую функциональность описанных диаграмм.
\end{itemize}

В CASE-пакете QReal была реализована следующая инфраструктура:

\begin{itemize}
  \item ``ядро'', обеспечивающее функциональность абстрактного редактора (реализовано вручную):
    \begin{itemize}
      \item способность элементов принадлежать диаграммам (в том числе, способность
            одного элемента принадлежать неограниченному числу диаграмм);
          \item способность получать значения нужных атрибутов из репозитория и
            отслеживать изменения его содержимого;
          \item способность элементов отрисовываться в пределах рабочей области
            диаграммы;
          \item способность ассоциаций соединять элементы и способность элементов
            присоединять к себе ассоциации;
          \item способность абстрактного элемента быть контейнером для других;
          \item способность элемента реагировать на действия пользователя (например, на
            выделение курсором мыши, перемещение, изменение размеров) и т.п.
    \end{itemize}
  \item наследуемые от ``ядра'' классы, определяющие специфику конкретных типов
        диаграмм (генерируются автоматически по XML-описаниям):
        \begin{itemize}
          \item набор допустимых для каждого конкретного типа диаграмм элементов;
          \item графические представления и параметризация их значениями атрибутов
                этих элементов;
          \item стиль начертания ассоциаций, форма и тип возможных стрелок;
          \item логические правила, специфичные для данного типа диаграмм (например,
                правила соединения элементов ассоциациями) и т.п.
        \end{itemize}
\end{itemize}

Необходимый для описания метамоделей диаграмм формат должен обладать
следующими возможностями:

\begin{itemize}
  \item задание графического представления элемента в текстовом виде (для
        элементов) или способа начертания линий и задания формы и типа стрелок
        (для ассоциаций);
  \item задание параметризации статического изображения элемента содержимым
        репозитория (например, отображение имени элемента);
  \item описание набора атрибутов элементов: поддержка как основных типов данных
        (строки, числа, логический тип, перечисление), так и возможность
        создания пользовательских;
  \item указание факта наследования элементов;
  \item описание логики ассоциаций: задание для каждого конца ассоциации набора
        допустимых для соединения с ним элементов, задание атрибутов ассоциаций
        (например, множественности или метки) и т.п.
\end{itemize}

Формат должен основываться на XML и иметь
простую структуру. Тогда создание новых редакторов или внесение
изменений в уже существующие не требует ни навыков программирования, ни
знания внутреннего устройства всего CASE-пакета и может осуществляться
пользователями напрямую.

Формат, обладающий описанными характеристиками и используемый в QReal, подробно 
описывается в дипломной работе Симоновой А.А.~\cite{simonova}.

\subsubsection{Генерация специфики диаграмм}

Процесс генерации редакторов в системе QReal организован так:
созданные описания метамоделей подаются на вход специальной
утилите-генератору, которая осуществляет анализ предоставленных ей
XML-документов, в результате чего для каждой сущности (как для элемента, 
так и для ассоциации) определяется список свойств с указанием их типа, 
список родительских элементов (сущность может наследовать свойства и логику
родительских элементов), отображаемое имя сущности и т.д.

Дополнительно сущности, представляющие вершины графа логической модели, имеют секцию описания
их графического представления (в первых версиях для его задания использовался язык SVG). 
Это описание сохранялось в виде файла на диске и использовалось как для отрисовки элементов 
в рабочей области редактора диаграмм, так и для создания иконок для палитры компонентов, 
инспектора объектов и диаграмм. Изображения, описанные на языке SVG, являются статичными, 
поэтому для их параметризации содержимым репозитория (например, для отрисовки имени элемента) 
используется специальная XML-секция. Для этого используются расширенные соответствующим образом
HTML-теги, поскольку инструментарий Qt предоставляет классы для интерпретации
и отрисовки основных тегов HTML~\cite{htmlInQt}. Таким образом
обеспечивается форматирование подставляемых из репозитория
значений. В ходе разбора соответствующих секций XML-описаний генератор заменяет теги
параметризации соответствующим C++ кодом для
получения нужных значений атрибутов элемента, при этом теги
форматирования текста сохраняются. Во время выполнения полученного кода 
произойдет обращение к репозиторию и значение атрибута будет отображено в рабочей
области редактора поверх статичного SVG-изображения элемента.

Здесь следует указать на то, что использование формата SVG, как и любого другого
графического формата общего назначения, позволяет реализовать только
самые простые редакторы, поскольку в развитом CASE-средстве
графические элементы могут обладать достаточно сложным поведением, невыразимым
ни статическим, ни параметризованным изображением. 
% TODO: Где-то была статья про использование SVG для задания графики, найти и сослаться
Представляется, что CASE-средства
должны иметь специализированный формат задания графических элементов. В системе
QReal от использования формата SVG в результате пришлось отказаться, хотя общий
принцип наличия секции с графическим представлением элементов в XML-описаниях
был сохранён. Самым простым примером невыразимого в SVG аспекта отрисовки
элементов являются порты.

Порты --- это области графического отображения элемента, к которым возможно присоединение ассоциаций.
Формат (а следовательно, и генератор) поддерживает задание портов двух
типов --- точка и отрезок (в случае последнего ассоциация может быть
прикреплена к любой точке отрезка). Вся функциональность по обработке
присоединения к портам и адекватного отображения ассоциаций при
изменении размера/движении элемента реализована в ядре редактора, в генерируемых классах
конкретных элементов достаточно лишь указать тип и расположение порта.

Для сущностей, представляющих рёбра графа модели, для каждого из концов 
ассоциации указывается набор типов
элементов, к которым она может быть прикреплена, тип начертания линии 
ассоциации при ее визуальном отображении, формы и стиля закраски
стрелок, например, задание обычных стрелок и стрелок в
виде ромба (как закрашенные, так и нет для обоих вариантов).

После разбора XML-описаний метамоделей производится построение набора свойств
сущностей (с учетом наследования элементов), списка возможных для присоединения элементов 
ассоциаций (для каждого из концов), проверяется ссылочная целостность, выполняются
другие проверки семантической корректности описаний редакторов.

В ходе заключительной фазы происходит генерация необходимых артефактов, а именно, создаются:

\begin{itemize}
  \item классы на языке C++ для всех элементов и
        ассоциаций диаграмм;
  \item файлы с описаниями графического представления элементов;
  \item внутренние средства доступа к значениям атрибутов элементов в
        репозитории из любых модулей проекта.
  \item дополнительный код для присоединения генерируемых классов к проекту. В
        него входят фабрика объектов для создания экземпляров описанных типов
        элементов и ассоциаций, а также служебные файлы --- файл ресурсов проекта
        и файл, осуществляющий включение генерируемых файлов с классами
        описанных сущностей в процесс сборки проекта.
\end{itemize}

Подробнее генератор редакторов описан в дипломной работе Брыксина Т.А.~\cite{bryksin}.

\section{Дальнейшее развитие}
\subsection{Доработка репозитория}

После создания и апробации первого работающего прототипа
CASE-системы были сформированы основные замечания к нему.

\begin{itemize}
  \item Использование реляционной СУБД в качестве сервера репозитория делает
        невозможным оповещение подключенных клиентов об изменении хранимых
        данных.
  \item Набор хранимых на сервере элементов определялся схемой текущей базы
        данных, которая генерировалась по описаниям метамоделей диаграмм. В
        результате, если несколько клиентов имели бы разный набор редакторов (или,
        что еще хуже, разные версии одних и тех же редакторов), то работа с
        ними сопровождалась бы большим количеством ошибок, содержимое
        репозитория с большой вероятностью было бы испорчено.
  \item Неэффективность некоторых типов запросов (упреждающая загрузка,
        отложенное чтение) и кэширования.
\end{itemize}

Все эти проблемы могли бы быть устранены либо расширением клиента
репозитория (реализацией механизма опроса, хранением дополнительной
информации о редакторах и проверкой ее в клиенте перед началом работы
и т.п.), либо введением некой программной ``прослойки'' между клиентом
репозитория и СУБД, в которую можно было бы вынести всю необходимую
дополнительную функциональность.

Анализ этих и некоторых других замечаний к существующему решению дал
понять, что хотя выбранный при создании прототипа системы подход
построения репозитория на основе реляционной СУБД позволил в сжатые
сроки получить большую частью требуемой функциональности, в перспективе
потребуется его существенная доработка. 

В итоге было принято решение о реализации собственного сервера
репозитория, представляющего собой простую объектно-ориентированную
СУБД. При этом клиент репозитория должен инкапсулировать в себе всю
требуемую информацию для осуществления взаимодействия с удаленным
сервером и предоставлять всем остальным компонентам системы доступ к
данным посредством фиксированного API. 

Первоначально общение между клиентом и сервером репозитория
осуществлялось с помощью текстового протокола поверх
TCP/IP, однако с появлением первых генераторов CASE-пакета
была поставлена задача поддержки протокола более высокого уровня. Это
объяснялось тем, что первые генераторы писались на языке
C\# под платформу .NET, а клиент репозитория --- на языке
C++ с обширным использованием возможностей
инструментария Qt. Поэтому удачным, на наш
взгляд, решением проблемы организации взаимодействия этих компонент
явилось внедрение высокоуровневого RPC
протокола взаимодействия клиента и сервера репозитория --- таким образом,
для каждого языка/платформы этот интерфейс необходимо реализовать
только один раз. В качестве такого протокола был выбран
ZeroC ICE~\cite{ice}.

\subsection{Замена формату SVG}

Еще одной проблемой созданного прототипа было масштабирование
графических изображений элементов на диаграммах. Для задания
представлений элементов использовался формат SVG, что позволяло быстро
создавать векторные изображения и обрабатывать их стандартными
средствами модуля QtSvg (в Qt реализована поддержка
\href{http://www.w3.org/TR/SVGMobile12/}{\textstyleInternetlink{SVG 1.2 Tiny}}). 
Однако, изображения векторной графики при масштабировании
изменяют свои размеры и толщину линий пропорционально растяжению всей
фигуры, что приводило к ситуациям, проиллюстрированным на рис.~\ref{scaling}.

\begin{figure} [ht]
  \begin{center}
    \includegraphics[width=0.5\textwidth]{draft04-img3.jpg}
    \caption{Элемент до (слева) и после (справа) масштабирования}
    \label{scaling}
  \end{center}
\end{figure}

Пользоваться такими фигурами было неудобно, а так как формат
SVG не предоставляет средств для его
расширения, была поставлена задача создания собственного языка описания
графических представлений элементов на замену SVG (и, соответственно,
реализация средств отрисовки изображений, описанных с помощью этого
языка). Основными требованиями к нему стали стала поддержка
дифференцированного масштабирования элементов --- возможность при
описании элемента задавать тип масштабирования составляющих его частей.
В результате был создан язык SDF (stencil description format) и
средства его отрисовки, которые поддерживают два вида масштабирования:

\begin{itemize}
  \item Абсолютное --- размер графического примитива задается в явном виде и при
        масштабировании не меняется;\newline
    \includegraphics[width=0.7\textwidth]{draft04-img4.jpg}
  \item Процентное --- размер графического примитива задается в процентах от
        общего размера элемента (сюда же входит и ``обычное'' пропорциональное
        масштабирование).\newline
    \includegraphics[width=0.7\textwidth]{draft04-img5.jpg}
\end{itemize}

Кроме того, были созданы средства конвертации SVG-описаний в формат SDF
для преобразования большого числа уже имеющихся SVG-изображений
элементов. К тому же, мы получили гибкий формат, который можно быстро
изменять под свои дальнейшие нужды.

\subsection{Доработка внутреннего представления моделей}

В результате работы над прототипом возникло более чёткое понимание того,
как модели должны храниться в репозитории и отображаться в пользовательском
интерфейсе. Проблема, общая для всех CASE-систем, состоит в том, что 
было бы удобно иметь чётко выраженную логическую модель, с которой 
удобно работать генераторам кода, и при этом иметь возможность в процессе 
моделирования рассматривать моделируемую систему с различных точек зрения.
% TODO: ссылка на текст Кознова про диаграммы и графы модели?
К примеру, модель некоторой системы может содержать диаграммы автоматов, 
описывающие поведение каких-либо классов, и диаграммы последовательности, 
которые описывают некоторые сценарии взаимодействия объектов этих классов.
Естественно, такая модель может содержать избыточную информацию, 
которую необходимо автоматически поддерживать согласованной.

Поэтому имеет смысл явно разделить модель на логическую и графическую составляющие.
При этом одной логической сущности может соответствовать несколько (или ни одного) 
графических представлений. Представления имеют атрибуты, относящиеся непосредственно к графике, 
как то положение, размеры, форма, цвет, отображать ли поля/методы и т.д. 
Все существенные с точки зрения логики модели атрибуты (поля, методы, ассоциации и т.д.) 
хранятся в логической сущности и только отображаются представлениями. Это полезно для 
поддержания консистентности, поскольку, меняя существенные атрибуты одного представления 
логической сущности, мы меняем саму логическую сущность, 
автоматически меняя тем самым остальные её представления. 

Сущности логической и графической модели взаимосвязаны следующим образом.
\begin{itemize}
  \item Элемент графической модели может иметь один прототип --- логическую сущность 
    (``обычные'' элементы) или не иметь прототипа --- специальные графические сущности, 
    предназначенные для группировки графических элементов, аннотации диаграмм, рисования и т.д. 
    Пример такого представления, не имеющего логического прообраза --- диаграмма (как элемент графической модели).
    Диаграмма может рассматриваться как способ группировки графических элементов
    и не должна быть видна генераторам (которые, как правило, используют для группировки пакеты).
  \item Один элемент логической модели может иметь ноль или больше представлений. 
    Представления могут не только иметь разные параметры отображения, но и вообще задаваться 
    разными фигурами и иметь разный набор ``существенных'' атрибутов. Элемент логической модели 
    можно представить как объединение существенных атрибутов всех его возможных представлений (существенными
    атрибутами представления здесь называются атрибуты логической сущности, 
    с которыми пользователь может взаимодействовать через представление).
  \item Связи между элементами логической модели довольно просты --- отношение ``родитель-сын''
    (точнее, ``контейнер-элемент'') и ссылки на другие объекты или ассоциации. В графической модели
    связи между элементами могут отражать способ визуальной группировки элементов и могут
    быть довольно сложными --- ``родитель-сын'' (один элемент может находиться внутри другого
    и, например, перемещаться по диаграмме как единое целое), ``встроенный'' элемент, имеющий
    фиксированную внутри элемента-родителя позицию (например, метод в классе) и прочие виды связей,
    которые могут задаваться, например, графическими грамматиками \cite{koznov}.
  \item Хранить в репозитории необходимо отдельно логическую и графическую части модели.
    Выделение графических представлений в отдельные сущности репозитория полезно для 
    организации многопользовательской работы, поскольку в этом случае изменение
    графических свойств какого-либо представления может быть осуществлено независимо от
    логической сущности, а значит, с меньшей вероятностью приведёт к конфликту.
  \item В пользовательском интерфейсе должны отображаться обе части модели (например, в виде
    двух отдельных деревьев), при этом должна быть обеспечена синхронность вносимых изменений.
\end{itemize}

\subsection{Метаредактор}

Долгое время XML-описания редакторов в системе  QReal писались вручную, однако,
сами XML-описания можно рассматривать как целевой текстовый язык для генерации
из визуальной модели. Для этого в QReal был создан ещё один графический редактор
(метаредактор, т.е. редактор графических редакторов).
По сути, метаредактор предоставляет пользователям визуальный язык, являющийся подмножеством
стандартного языка MOF (Meta Object Facility)~\cite{mof} , на котором описываются все
метамодели, например, метамодель UML. Практика показывает, что достаточно реализовать лишь
небольшой набор элементов MOF: 

\begin{itemize}
  \item классы (задают множество элементов конкретного типа);
  \item ассоциации между ними (например, для задания отношения наследования);
  \item атрибуты классов (например, используемые для задания свойств элементов
        заданного типа).
\end{itemize}

На данный момент нам кажется, что этих сущностей достаточно, чтобы
описать метамодели всех возможных редакторов, поддерживаемых нашим
CASE-средством. Метаредактор был создан в достаточно короткое время,
что подтвердило эффективность предлагаемого генеративного подхода
к созданию редакторов.

\section*{Заключение}

Описанный в этой статье прототип CASE-системы был
реализован, в данный момент проводится его доработка (как в описанных
направлениях, так и в некоторых других). Параллельно с этим, группой
студентов и аспирантов кафедры системного программирования
осуществляется создание и применение генераторов для различных
предметных областей.

При реализации прототипа были выявлены следующие проблемы:
\begin{itemize}
  \item выбор способа хранения моделей с учётом обеспечения эффективной многопользовательской работы, 
    хранения больших объёмов данных и поддержки версионирования;
  \item задание графических свойств элементов моделей, которые могут сложным образом
    взаимодействовать с пользователем;
  \item выбор внутреннего представления модели, обеспечившего бы удобство работы генераторов кода
    и возможность моделировать разрабатываемую систему с различных точек зрения.
\end{itemize}

В статье рассмотрены решения этих и некоторых других проблем, 
реализованные в системе QReal, а также был предложен генеративный 
подход к созданию редакторов, который позволяет существенно улучшить сопровождаемость и 
сократить время разработки CASE-систем, от которых может требоваться поддержка
новых виуальных языков.

\pagebreak

\begin{thebibliography}{99}
  \bibitem{bryksin} Брыксин Т.А., Model/View-архитектура CASE-пакета REAL-MV, дипломная работа, 2007, URL: http://unreal.tepkom.ru/trac/attachment/wiki/Diplomes/ Bryksin\_Diploma.doc (дата обращения: 11.05.09)
  \bibitem{koznov} Кознов Д.В., Основы визуального моделирования, БИНОМ. Лаборатория знаний, Интернет-университет информационных технологий - ИНТУИТ.ру, 2008
  \bibitem{koznovDsl} Кознов Д.В., Ольхович Л.Б., Визуальные языки проектов. // Системное программирование. Вып. 1: Сб. статей / Под ред. А.Н.Терехова, Д.Ю.Булычева. --- СПб.: 2004, с. 148-167,
    URL: http://www.sysprog.info/2004/08.pdf (дата обращения: 28.06.09)
  \bibitem{nikandrov} Никандров Г., Реализация кроссплатформенной архитектуры CASE-пакета, дипломная работа, 2007, URL: http://unreal.tepkom.ru/trac/attachment/wiki/Diplomes/\newline Nikandrov\_Diploma.pdf 
    (дата обращения: 11.05.09)
  \bibitem{simonova} Симонова А.А., Подход к разработке CASE-пакетов, дипломная работа, 2007, URL: http://unreal.tepkom.ru/trac/attachment/wiki/Diplomes/\newline Simonova\_Diploma.doc (дата обращения: 11.05.09)
  \bibitem{real} Терехов А., Иванов А., Кознов Дм., Лебедев А., Мурашова Т., Парфенов В., Объектно-ориентированное расширение технологии RTST, СПб.; Изд. СПбГУ, 1998
  \bibitem{realIt} Терехов А.Н., Романовский К.Ю., Кознов Д.В., Долгов П.С., Иванов А.Н., REAL: методология и CASE-средство для разработки систем реального времени и информационных cистем, Программирование, 1999, № 5. с. 44-52
  \bibitem{gme} Akos Ledeczi, Miklos Maroti, Arpad Bakay et al., The Generic Modeling Environment, published in the Proceedings of WISP'2001, May, 2001
  \bibitem{ice} The Internet Communications Engine, ZeroC Inc., 2009, URL: http://www.zeroc.com/ice.html (дата обращения: 11.05.09)
  \bibitem{mof} Meta Object Facility (MOF) Core Specification, Version 2.0, Object Management Group, 2006, URL: http://www.omg.org/spec/MOF/2.0/ (дата обращения: 10.05.09)
  \bibitem{svgTiny} Mobile SVG Profiles: SVG Tiny and SVG Basic, The World Wide Web Consortium, 2003, URL: http://www.w3.org/TR/SVGMobile/ (дата обращения: 10.05.09)
  \bibitem{htmlInQt} Supported HTML Subset, документация библиотеки Qt, Nokia Corporation, 2009, URL: http://doc.trolltech.com/4.5/richtext-html-subset.html (дата обращения: 11.05.09)
  \bibitem{amln} Thomas G. Muth, Functional Structures in Networks, Springer, 2005
\end{thebibliography}

\end{document}
